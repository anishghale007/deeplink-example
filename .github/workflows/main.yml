name: Create Course from JSON file

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  updateCourse:
    runs-on: ubuntu-latest

    # Run only if the PR was merged into main
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # IMPORTANT for HEAD^ to work

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Process changed JSON files only
        run: |
          echo "Detecting changed JSON files..."

          FILES=$(git diff --name-only HEAD^ HEAD \
            | grep '\.json$' \
            | grep -v -E '(^|/)curriculum_schema_.*\.json$' \
            || true)

          if [ -z "$FILES" ]; then
            echo "No JSON files changed (schema files ignored)."
            exit 0
          fi

          for FILE in $FILES; do
            echo "----------------------------------------"
            echo "Processing file: $FILE"

            # Old content (empty if new file)
            OLD_CONTENT=$(git show HEAD^:"$FILE" 2>/dev/null || echo "{}")

            OLD_HASH=$(echo "$OLD_CONTENT" | jq -c . | sha256sum | awk '{print $1}')
            NEW_HASH=$(jq -c . "$FILE" | sha256sum | awk '{print $1}')

            echo "Old hash: $OLD_HASH"
            echo "New hash: $NEW_HASH"

            if [ "$OLD_HASH" = "$NEW_HASH" ]; then
              echo "No changes detected. Skipping."
              continue
            fi

            COURSE_DATA=$(jq -c . "$FILE")

            curl -X POST "${{ secrets.CREATE_COURSE_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"course_data\": $COURSE_DATA,
                \"old_hash_code\": \"$OLD_HASH\",
                \"new_hash_code\": \"$NEW_HASH\",
                \"file_path\": \"$FILE\"
              }"

            echo "Lambda request sent for $FILE"
          done
